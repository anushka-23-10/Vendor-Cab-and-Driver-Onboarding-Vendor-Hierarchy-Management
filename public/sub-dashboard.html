<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SubVendor Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    form { margin-bottom: 25px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    input, select, button { margin: 8px 0; padding: 10px; width: 100%; }
  </style>
</head>
<body>
  <h2>SubVendor Dashboard</h2>

  <section>
    <h3>Add Driver</h3>
    <form id="driverForm">
      <input type="text" id="driverName" placeholder="Driver Name" required />
      <input type="text" id="driverPhone" placeholder="Phone Number" />
      <input type="text" id="license" placeholder="License Number" />
      <input type="text" id="vehicle" placeholder="Assigned Vehicle (optional)" />
      <button type="submit">Add Driver</button>
    </form>
  </section>

  <section>
    <h3>Create Child SubVendor</h3>
    <form id="childVendorForm">
      <input type="text" id="childName" placeholder="SubVendor Name" required />
      <input type="text" id="childContact" placeholder="Contact Info" required />
      <input type="text" id="childUsername" placeholder="Username for subvendor login" required />
      <label>Allowed Roles:</label>
      <select id="childRole" required></select>
      <input type="text" id="superVendorId" placeholder="SuperVendor ID" readonly required />
      <button type="submit">Create SubVendor</button>
    </form>
  </section>

  <script>
    const token = localStorage.getItem("token");

    async function init() {
      if (!token) return (window.location.href = "vendor-login.html");

      const meRes = await fetch("/api/vendors/me", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const me = await meRes.json();
      if (!me.vendor) return alert("Unable to load vendor info");

      document.getElementById("superVendorId").value = me.vendor.superVendorId;

      const role = me.vendor.role;
      const dropdown = document.getElementById("childRole");

      const allowed = {
        SuperVendor: ["RegionalVendor", "CityVendor", "LocalVendor"],
        RegionalVendor: ["CityVendor", "LocalVendor"],
        CityVendor: ["LocalVendor"],
        LocalVendor: [],
      }[role] || [];

      dropdown.innerHTML = allowed.length
        ? allowed.map(r => `<option value="${r}">${r}</option>`).join("")
        : "<option disabled>No roles available</option>";
    }

    // add driver
    document.getElementById("driverForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("driverName").value;
      const phone = document.getElementById("driverPhone").value;
      const licenseNumber = document.getElementById("license").value;
      const assignedVehicle = document.getElementById("vehicle").value;

      const res = await fetch("/api/drivers/add", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ name, phone, licenseNumber, assignedVehicle }),
      });

      const data = await res.json();
      alert(res.ok ? "Driver added successfully!" : data.error || "Failed");
    });

    // create child subvendor
    document.getElementById("childVendorForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("childName").value;
      const contactInfo = document.getElementById("childContact").value;
      const username = document.getElementById("childUsername").value;
      const role = document.getElementById("childRole").value;
      const superVendorId = document.getElementById("superVendorId").value;

      const res = await fetch("/api/vendors/create-subvendor", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ name, contactInfo, username, role, superVendorId }),
      });
      const data = await res.json();
      alert(res.ok ? "SubVendor created successfully!" : data.error);
    });

    init();
  </script>
</body>
</html>
