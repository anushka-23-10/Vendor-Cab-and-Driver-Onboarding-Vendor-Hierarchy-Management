<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SubVendor Fleet & Compliance Dashboard</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f7f9fb;
        margin: 0;
        padding: 20px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
      }

      header h2 {
        margin: 0;
      }

      header button {
        background: white;
        color: #007bff;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
      }

      header button:hover {
        background: #e4ecff;
      }

      section {
        background: white;
        padding: 20px;
        margin-top: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        max-width: 1100px;
        margin-left: auto;
        margin-right: auto;
      }

      h3 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 6px;
      }

      input,
      select,
      button {
        display: block;
        width: 100%;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }

      button {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        cursor: pointer;
        border: none;
      }

      button:hover {
        background-color: #0056b3;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #007bff;
        color: white;
      }

      #vendorInfo {
        background: #eef3ff;
        padding: 10px;
        border-radius: 8px;
        font-size: 15px;
        margin-top: 10px;
        text-align: center;
      }

      .green {
        color: green;
        font-weight: bold;
      }

      .red {
        color: red;
        font-weight: bold;
      }

      .orange {
        color: orange;
        font-weight: bold;
      }

      .list-title {
        margin-top: 20px;
        color: #444;
        font-size: 15px;
      }
    </style>
  </head>

  <body>
    <header>
      <h2>SubVendor Fleet & Compliance Dashboard</h2>
      <div>
        <button id="logoutBtn">Logout</button>
      </div>
    </header>

    <div id="vendorInfo">
      <b>Logged in as:</b> <span id="vendorName">Loading...</span> |
      <b>Role:</b> <span id="vendorRole">-</span> | <b>Region:</b>
      <span id="vendorRegion">-</span>
    </div>

    <!-- ========== VEHICLES ========== -->
    <section>
      <h3>üöó Vehicle Management</h3>
      <form id="vehicleForm">
        <input
          type="text"
          id="regNum"
          placeholder="Registration Number"
          required
        />
        <input type="text" id="model" placeholder="Model" required />
        <input
          type="text"
          id="capacity"
          placeholder="Seating Capacity"
          required
        />
        <input type="text" id="fuel" placeholder="Fuel Type" required />
        <button type="submit">Add Vehicle</button>
      </form>

      <h4 class="list-title">üìã Vehicle List</h4>
      <table id="vehicleTable">
        <thead>
          <tr>
            <th>Registration No</th>
            <th>Model</th>
            <th>Fuel Type</th>
            <th>Capacity</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ========== DRIVERS ========== -->
    <section>
      <h3>üë• Driver Management</h3>
      <form id="driverForm">
        <input type="text" id="driverName" placeholder="Driver Name" required />
        <input type="text" id="license" placeholder="License Number" required />
        <input type="email" id="email" placeholder="Driver Email" required />
        <select id="assignVehicle" required></select>
        <button type="submit">Add Driver</button>
      </form>

      <h4 class="list-title">üìã Driver List</h4>
      <table id="driverTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>License</th>
            <th>Email</th>
            <th>Vehicle</th>
            <th>Compliance</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ========== DOCUMENTS ========== -->
    <section>
      <h3>üìÑ Document Upload</h3>
      <form id="uploadForm" enctype="multipart/form-data">
        <select id="driverSelect" required></select>
        <select id="docType" required>
          <option value="Driving License">Driving License</option>
          <option value="RC">Registration Certificate</option>
          <option value="Permit">Permit</option>
          <option value="Pollution">Pollution Certificate</option>
          <option value="Insurance">Insurance</option>
        </select>
        <input type="date" id="expiryDate" />
        <input type="file" id="fileInput" required />
        <button type="submit">Upload Document</button>
      </form>

      <h4 class="list-title">üìã Uploaded Documents</h4>
      <table id="docTable">
        <thead>
          <tr>
            <th>Driver</th>
            <th>Document Type</th>
            <th>Upload Date</th>
            <th>Expiry Date</th>
            <th>Status</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ========== SUBVENDORS ========== -->
    <section>
      <h3>üè¢ SubVendor Hierarchy</h3>
      <form id="childVendorForm">
        <input
          type="text"
          id="childName"
          placeholder="SubVendor Name"
          required
        />
        <input
          type="email"
          id="childContact"
          placeholder="Contact Email"
          required
        />
        <input type="text" id="childUsername" placeholder="Username" required />
        <select id="childRole" required></select>
        <input type="text" id="childRegion" placeholder="Region" required />
        <button type="submit">Create SubVendor</button>
      </form>

      <h4 class="list-title">üìã Child SubVendor List</h4>
      <table id="childVendorTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th>Region</th>
            <th>Role</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
    <section>
      <h3>Fleet Overview</h3>
      <table id="fleetTable">
        <thead>
          <tr>
            <th>Registration No.</th>
            <th>Model</th>
            <th>Fuel Type</th>
            <th>Seating</th>
            <th>Assigned Driver</th>
            <th>Compliance</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <script>
      const token = localStorage.getItem("token");
      const role = localStorage.getItem("role");
      const allowedRoles = [
        "SubVendor",
        "RegionalVendor",
        "CityVendor",
        "LocalVendor",
      ];

      if (!token || !allowedRoles.includes(role)) {
        alert("Unauthorized access. Please log in as a valid SubVendor.");
        window.location.href = "index.html";
      }

      async function verifyLogin() {
        const res = await fetch("/api/vendors/me", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();

        if (!data.vendor) {
          alert("Session expired. Please log in again.");
          localStorage.clear();
          window.location.href = "index.html";
          return;
        }

        document.getElementById("vendorName").innerText = data.vendor.name;
        document.getElementById("vendorRole").innerText = data.vendor.role;
        document.getElementById("vendorRegion").innerText =
          data.vendor.region || "N/A";

        const allowed =
          {
            SuperVendor: ["RegionalVendor", "CityVendor", "LocalVendor"],
            RegionalVendor: ["CityVendor", "LocalVendor"],
            CityVendor: ["LocalVendor"],
            LocalVendor: [],
          }[data.vendor.role] || [];

        document.getElementById("childRole").innerHTML = allowed
          .map((r) => `<option value="${r}">${r}</option>`)
          .join("");

        loadVehicles();
        loadDrivers();
        loadDocuments();
        loadChildVendors();
      }

      async function loadVehicles() {
        const res = await fetch("/api/vehicles/my", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const tbody = document.querySelector("#vehicleTable tbody");
        const assignVehicle = document.getElementById("assignVehicle");
        assignVehicle.innerHTML = "";
        tbody.innerHTML = "";

        if (!data.vehicles || data.vehicles.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No vehicles found</td></tr>`;
          return;
        }

        data.vehicles.forEach((v) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${v.registrationNumber}</td><td>${v.model}</td><td>${v.fuelType}</td><td>${v.capacity}</td>`;
          tbody.appendChild(tr);
          assignVehicle.innerHTML += `<option value="${v.registrationNumber}">${v.registrationNumber}</option>`;
        });
      }

      async function loadDrivers() {
        const res = await fetch("/api/drivers/list", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const tbody = document.querySelector("#driverTable tbody");
        const driverSelect = document.getElementById("driverSelect");
        driverSelect.innerHTML = "";
        tbody.innerHTML = "";

        if (!data.drivers || data.drivers.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No drivers found</td></tr>`;
          return;
        }

        data.drivers.forEach((d) => {
          const color = d.compliant ? "green" : "red";
          const badge = d.compliant ? "‚úÖ Compliant" : "‚ö†Ô∏è Non-Compliant";

          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${d.name}</td>
      <td>${d.licenseNumber}</td>
      <td>${d.contactInfo}</td>
      <td>${d.assignedVehicle || "-"}</td>
      <td class="${color}">${badge}</td>
    `;
          tbody.appendChild(tr);
          driverSelect.innerHTML += `<option value="${d._id}">${d.name}</option>`;
        });
      }
      async function loadFleetOverview() {
        const res = await fetch("/api/vehicles/overview", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const tbody = document.querySelector("#fleetTable tbody");
        tbody.innerHTML = "";

        if (!data.fleet || data.fleet.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center;">No vehicles found</td></tr>';
          return;
        }

        data.fleet.forEach((v) => {
          const color = v.compliance.includes("‚úÖ")
            ? "green"
            : v.compliance.includes("‚ùå")
            ? "red"
            : "orange";

          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${v.registrationNumber}</td>
      <td>${v.model}</td>
      <td>${v.fuelType}</td>
      <td>${v.seatingCapacity}</td>
      <td>${v.assignedDriver}</td>
      <td class="${color}">${v.compliance}</td>
    `;
          tbody.appendChild(tr);
        });
      }

      async function loadDocuments() {
        const res = await fetch("/api/documents/my", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const tbody = document.querySelector("#docTable tbody");
        tbody.innerHTML = "";

        if (!data.documents || data.documents.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No documents found</td></tr>`;
          return;
        }

        data.documents.forEach((d) => {
          let color =
            d.status === "Approved"
              ? "green"
              : d.status === "Rejected"
              ? "red"
              : "orange";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.driverId?.name || "-"}</td>
            <td>${d.docType}</td>
            <td>${new Date(d.uploadDate).toLocaleDateString()}</td>
            <td>${
              d.expiryDate ? new Date(d.expiryDate).toLocaleDateString() : "-"
            }</td>
            <td class="${color}">${d.status}</td>
            <td><a href="${d.filePath}" target="_blank">üìÑ View</a></td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function loadChildVendors() {
        const res = await fetch("/api/vendors/my-subvendors", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const tbody = document.querySelector("#childVendorTable tbody");
        tbody.innerHTML = "";

        if (!data.vendors || data.vendors.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No child vendors</td></tr>`;
          return;
        }

        data.vendors.forEach((v) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${v.name}</td><td>${v.contactInfo}</td><td>${v.region}</td><td>${v.role}</td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "index.html";
      });

      // üîπ Add Vehicle
      document
        .getElementById("vehicleForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const res = await fetch("/api/vehicles/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              registrationNumber: regNum.value,
              model: model.value,
              capacity: capacity.value,
              fuelType: fuel.value,
            }),
          });
          alert(res.ok ? "Vehicle added!" : "Error adding vehicle");
          loadVehicles();
        });

      // üîπ Add Driver
      document
        .getElementById("driverForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const res = await fetch("/api/drivers/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              name: driverName.value,
              licenseNumber: license.value,
              contactInfo: email.value,
              assignedVehicle: assignVehicle.value,
            }),
          });
          alert(res.ok ? "Driver added!" : "Error adding driver");
          loadDrivers();
        });

      // üîπ Upload Document
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData();
          formData.append("driverId", driverSelect.value);
          formData.append("docType", docType.value);
          formData.append("expiryDate", expiryDate.value);
          formData.append("file", fileInput.files[0]);
          const res = await fetch("/api/documents/upload", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });
          alert(res.ok ? "Document uploaded!" : "Error uploading document");
          loadDocuments();
        });

      // üîπ Create Child Vendor
      document
        .getElementById("childVendorForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const res = await fetch("/api/vendors/create-subvendor", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              name: childName.value,
              contactInfo: childContact.value,
              username: childUsername.value,
              role: childRole.value,
              region: childRegion.value,
            }),
          });
          alert(res.ok ? "SubVendor created!" : "Error creating subvendor");
          loadChildVendors();
        });

      verifyLogin();
      loadFleetOverview(); // ‚úÖ show Fleet overview table automatically
    </script>
  </body>
</html>
